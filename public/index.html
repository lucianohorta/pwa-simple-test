<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello World PWA + Push Notifications</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/icon-192.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Hello World PWA + Push Notifications</h1>
    <button id="subscribe">Enable Push Notification</button>
    <div id="status"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-messaging-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyBk_c4KxIWghSZYWiTesJP4Ho9XXdp4XWs",
            authDomain: "pwa-ios-bba82.firebaseapp.com",
            projectId: "pwa-ios-bba82",
            storageBucket: "pwa-ios-bba82.firebasestorage.app",
            messagingSenderId: "894142973830",
            appId: "1:894142973830:web:2f124ebbd5e183b7b58e07"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging(app);
        const statusEl = document.getElementById('status');
        const subscribeBtn = document.getElementById('subscribe');

        // Check service worker support
        if (!('serviceWorker' in navigator)) {
            statusEl.textContent = "Error: Your browser doesn't support service workers";
            subscribeBtn.disabled = true;
            return;
        }

        // Register service worker
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
            .then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
            
            // Modified button handler with full error handling
            subscribeBtn.addEventListener('click', async () => {
                try {
                    subscribeBtn.disabled = true;
                    statusEl.textContent = "Requesting permission...";
                    
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        statusEl.textContent = "Notifications blocked";
                        subscribeBtn.disabled = false;
                        return;
                    }
                    
                    statusEl.textContent = "Generating token...";
                    const token = await messaging.getToken({
                        serviceWorkerRegistration: registration,
                        vapidKey: "BOyQvrJPgC9d-mEncQGz93pEbhB1IghXhgln42SBx3BVhCkO6JwWMA1MSYVdCMRiA_BpspdWvnJDXgeP91o-vNA"
                    });
                    
                    console.log("FCM Token:", token);
                    statusEl.textContent = "Saving token...";
                    
                    try {
                    const response = await fetch('/api/save-token', {
                        method: 'POST',
                        headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                        },
                        body: JSON.stringify({ token })
                    });
                    
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Failed to save');
                    
                    statusEl.textContent = "âœ” Ready for notifications!";
                    subscribeBtn.textContent = "Enabled";
                    } catch (fetchError) {
                        console.error("Save token error:", fetchError);
                        statusEl.textContent = `Error: ${fetchError.message}`;
                        subscribeBtn.disabled = false;
                    }
                    
                } catch (error) {
                    console.error("Notification error:", error);
                    statusEl.textContent = `Error: ${error.message}`;
                    subscribeBtn.disabled = false;
                }
            });
            
            })
            .catch(error => {
            console.error('Service Worker registration failed:', error);
            statusEl.textContent = "Error: Failed to register service worker";
            subscribeBtn.disabled = true;
            });
        });
    </script>
</body>
</html>