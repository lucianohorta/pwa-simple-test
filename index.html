<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lembretes Diários PWA</title>

<!-- Manifest -->
<link rel="manifest" href="/manifest.json" />
<link rel="icon" href="/icon-192.png" />

<!-- iOS support -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Lembretes" />
<link rel="apple-touch-icon" href="/icon-192.png" />

<link rel="stylesheet" href="/style.css" />
</head>
<body>
<h1>Lembretes Diários</h1>
<p>Receba um lembrete por notificação push todos os dias!</p>
<button id="subscribe">Ativar Notificações</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-messaging-compat.js"></script>

<script>
    const firebaseConfig = {
    apiKey: "AIzaSyBk_c4KxIWghSZYWiTesJP4Ho9XXdp4XWs",
    authDomain: "pwa-ios-bba82.firebaseapp.com",
    projectId: "pwa-ios-bba82",
    storageBucket: "pwa-ios-bba82.firebasestorage.app",
    messagingSenderId: "894142973830",
    appId: "1:894142973830:web:2f124ebbd5e183b7b58e07",
    measurementId: "G-5R46BB6M38"
    };

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then(function (registration) {
        console.log('Service Worker registrado com sucesso', registration);

        document.getElementById('subscribe').addEventListener('click', async () => {
            try {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                const token = await messaging.getToken({
                vapidKey: 'BOyQvrJPgC9d-mEncQGz93pEbhB1IghXhgln42SBx3BVhCkO6JwWMA1MSYVdCMRiA_BpspdWvnJDXgeP91o-vNA',
                serviceWorkerRegistration: registration
                });
                console.log('Token:', token);

                // Envia o token pro backend
                fetch('/api/save-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                })

                .then(res => {
                if (res.ok) {
                    alert('Notificações ativadas e token salvo!');
                } else {
                    alert('Token gerado, mas houve erro ao salvar no servidor.');
                }
                })
                .catch(err => {
                console.error('Erro ao enviar token:', err);
                });
            } else {
                console.log('Permissão negada para notificações.');
            }
            } catch (error) {
            console.error('Erro ao ativar notificações', error);
            }
        });
        })
        .catch(function (err) {
        console.error('Erro ao registrar o Service Worker', err);
        });
    }
</script>
</body>
</html>
